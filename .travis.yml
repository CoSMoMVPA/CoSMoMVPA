# vim ft=yaml
# travis-ci.org definition for CoSMoMVPA build (based on PyMVPA, which is
# based on nipype configuration, which in turn was based on nipy)
#
# We pretend to be erlang because we need GNU Octave which is not 
# available (as of April 2015)

language: erlang
cache:
  - apt
env:
 global:
    - OCTAVE=octave
 matrix:
    - EXTERNALS=""
    - EXTERNALS="afni surfing fieldtrip libsvm gifti"
before_install:
    # to prevent IPv6 being used for APT
    - sudo bash -c "echo 'Acquire::ForceIPv4 \"true\";' > /etc/apt/apt.conf.d/99force-ipv4"
    # Prepare to get Octave
    - travis_retry sudo apt-get install -y -qq software-properties-common python-software-properties
    - travis_retry sudo apt-add-repository -y ppa:octave/stable
    - travis_retry sudo apt-get -y -qq update

    # get Octave 3.8
    - travis_retry sudo apt-get -y install octave
    - travis_retry sudo apt-get -y install liboctave-dev
    - travis_retry sudo apt-get -y -qq install octave

    # go up one level to retrieve MOxUnit
    - cd ..
    - git clone git://github.com/nno/MOxUnit.git
install:
    - PTH=`pwd`
    - BUILDCMD="more('off');"
    - OCTAVEPTH="${PTH}"
    - CHECKEXTCMD=""
    # optionally enable surfing toolbox
    - if [[ "$EXTERNALS" = *"surfing"* ]]; then
          git clone git://github.com/nno/surfing.git --depth 1;
          BUILDCMD="${BUILDCMD}cd('${PTH}/surfing');";
          BUILDCMD="${BUILDCMD}surfing_compile_mex();";
          BUILDCMD="${BUILDCMD}surfing_set_path();";
          OCTAVEPTH="${OCTAVEPTH}:${PTH}/surfing:${PTH}/surfing/surfing";
          CHECKEXTCMD="${CHECKEXTCMD}cosmo_check_external('surfing');";
      fi

    # optionally install afni
    - if [[ "$EXTERNALS" = *"afni"* ]]; then
          git clone git://github.com/afni/afni.git --depth 1;
          OCTAVEPTH="${OCTAVEPTH}:${PTH}/afni/src/matlab";
          CHECKEXTCMD="${CHECKEXTCMD}cosmo_check_external('afni');";
      fi

    # optionally install FieldTrip
    # Hopefull soon the official FieldTrip code can be used
    # currently (Apr 2015) we use our own version that
    # is compatible with Octave
    # (PR: https://github.com/fieldtrip/fieldtrip/pull/54)
    # TODO: git clone git://github.com/fieldtrip/fieldtrip.git --depth 1
    - if [[ "$EXTERNALS" = *"fieldtrip"* ]]; then
          git clone -b octave git://github.com/nno/fieldtrip.git;
          BUILDCMD="${BUILDCMD}ft_defaults();"
          OCTAVEPTH="${OCTAVEPTH}:${PTH}/fieldtrip";
          CHECKEXTCMD="${CHECKEXTCMD}cosmo_check_external('fieldtrip');";
      fi

    # optionally install libsvm
    - if [[ "$EXTERNALS" = *"libsvm"* ]]; then
          git clone git://github.com/cjlin1/libsvm.git;
          BUILDCMD="${BUILDCMD}cd('${PTH}/libsvm/matlab');";
          BUILDCMD="${BUILDCMD}make;";
          OCTAVEPTH="${OCTAVEPTH}:${PTH}/libsvm/matlab";
          CHECKEXTCMD="${CHECKEXTCMD}cosmo_check_external('libsvm');";
      fi

    # optionally install gifti library
    # TODO: update URL to refer to original website:
    #   http://www.artefact.tk/software/matlab/gifti/
    # when updated to version 1.5
    - if [[ "$EXTERNALS" = *"gifti"* ]]; then
          GIFTI_VERSION=1.5;
          GIFTI_NAME=gifti-${GIFTI_VERSION};
          wget http://www.artefact.tk/software/matlab/gifti/${GIFTI_NAME}.zip;
          unzip ${GIFTI_NAME}.zip
          BUILDCMD="${BUILDCMD}cd('${PTH}/${GIFTI_NAME}/@gifti/private');";
          BUILDCMD="${BUILDCMD}mex('zstream.c');";
          OCTAVEPTH="${OCTAVEPTH}:${PTH}/${GIFTI_NAME}";
          CHECKEXTCMD="${CHECKEXTCMD}cosmo_check_external('gifti');";
      fi

    # show path
    - BUILDCMD="${BUILDCMD}fprintf('path:\n%s\n', path());"

    # save path for when the script is being run
    - BUILDCMD="${BUILDCMD};savepath();exit();"

    # run build commands
    - $OCTAVE --path "${OCTAVEPTH}" --eval "${BUILDCMD}"


before_script:
    # add path for CoSMoMVPA
    - OCTAVEPTH="${OCTAVEPTH}:${PTH}/CoSMoMVPA/mvpa"
    - OCTAVEPTH="${OCTAVEPTH}:${PTH}/CoSMoMVPA/tests"
    - OCTAVEPTH="${OCTAVEPTH}:${PTH}/MOxUnit/MOxUnit"
    - TESTCMD="more('off');";
    - TESTCMD="${TESTCMD}cosmo_set_path();"
    - TESTCMD="${TESTCMD}${CHECKEXTCMD}"

    # randomize number generator and print the state
    - TESTCMD="${TESTCMD}prng_state=round(1000*clock());"
    - TESTCMD="${TESTCMD}disp('PRNG state:');disp(prng_state);fprintf('\n');"
    - TESTCMD="${TESTCMD}rand('state',prng_state);"

    # run tests, and quit with error if any test fails or errors
    - TESTDIR="CoSMoMVPA/tests"
    - TESTCMD="${TESTCMD}passed=moxunit_runtests('-verbose','${TESTDIR}');"
    - TESTCMD="${TESTCMD}if(~passed),cosmo_wtf();end;"
    - TESTCMD="${TESTCMD}exit(~passed);"
script:
    - $OCTAVE --path "${OCTAVEPTH}" --eval "${TESTCMD}"

