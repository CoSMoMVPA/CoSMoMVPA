# vim ft=yaml
# travis-ci.org definition for CoSMoMVPA build (based on PyMVPA, which is
# based on nipype configuration, which in turn was based on nipy)
#
# We pretend to be erlang because we need GNU Octave which is not 
# available (as of April 2015)

language: erlang
cache:
  - apt
env:
 global:
    - OCTAVE=octave
    - COSMOPATH=`pwd`
    - MVPAPATH=${COSMOPATH}/mvpa
 matrix:
    - EXTERNALS=""
    - EXTERNALS="afni surfing fieldtrip libsvm gifti octave_pkg_parallel"
before_install:
    # to prevent IPv6 being used for APT
    - sudo bash -c "echo 'Acquire::ForceIPv4 \"true\";' > /etc/apt/apt.conf.d/99force-ipv4"
    # get Octave 4.0
    - travis_retry sudo apt-get install -y -qq software-properties-common python-software-properties
    - travis_retry sudo apt-add-repository -y ppa:octave/stable
    - travis_retry sudo apt-get -y -qq update
    - travis_retry sudo apt-get -y install octave
    - travis_retry sudo apt-get -y install liboctave-dev
    - travis_retry sudo apt-get -y -qq install octave

    # use Clang
    - travis_retry sudo apt-get -y install clang
    - sudo update-alternatives --set c++ /usr/bin/clang++
    - sudo ln -f -s /usr/bin/clang++ /usr/bin/g++
    - c++ --version
    - g++ --version

    # go up one level to retrieve MOxUnit
    - cd ..
    - git clone git://github.com/nno/MOxUnit.git
    - make -C MOxUnit install
install:
    - PTH=`pwd`
    - OCTAVERC=~/.octaverc
    - OCTAVEPTH="${MVPAPATH}"
    - CHECKEXTCMD=""
    # optionally install surfing toolbox
    - if [[ "$EXTERNALS" = *"surfing"* ]]; then
          git clone git://github.com/nno/surfing.git --depth 1;
          make -C surfing install;
      fi

    # optionally install afni
    - if [[ "$EXTERNALS" = *"afni"* ]]; then
          git clone git://github.com/afni/afni.git --depth 1;
          $OCTAVE --eval "addpath('${PTH}/afni/src/matlab');savepath();";
      fi

    # optionally install FieldTrip
    # Hopefull soon the official FieldTrip code can be used
    # currently (Apr 2015) we use our own version that
    # is compatible with Octave
    # (PR: https://github.com/fieldtrip/fieldtrip/pull/54)
    # TODO: git clone git://github.com/fieldtrip/fieldtrip.git --depth 1
    - if [[ "$EXTERNALS" = *"fieldtrip"* ]]; then
          git clone -b _enh/octave git://github.com/nno/fieldtrip.git;
          $OCTAVE --eval "cd('${PTH}/fieldtrip');
                            ft_defaults();
                            savepath();";
      fi

    # optionally install libsvm
    - if [[ "$EXTERNALS" = *"libsvm"* ]]; then
          git clone git://github.com/cjlin1/libsvm.git;
          $OCTAVE --eval "cd('${PTH}/libsvm/matlab');
                        make;
                        addpath(pwd);
                        savepath();";
      fi

    # optionally install gifti library
    - if [[ "$EXTERNALS" = *"gifti"* ]]; then
          GIFTI_VERSION=1.5;
          GIFTI_NAME=gifti-${GIFTI_VERSION};
          wget http://www.artefact.tk/software/matlab/gifti/${GIFTI_NAME}.zip;
          unzip ${GIFTI_NAME}.zip;
          $OCTAVE --eval "cd('${PTH}/${GIFTI_NAME}/@gifti/private');
                          mex('zstream.c');
                          addpath('${PTH}/${GIFTI_NAME}');
                          savepath();";
      fi

    # optionally enable Octave parallel package
    - if [[ "$EXTERNALS" = *"octave_pkg_parallel"* ]]; then
          $OCTAVE --eval "pkg('install','-forge','parallel');";
          echo "" >> ~/.octaverc;
          echo "pkg load parallel;" >> $OCTAVERC;
      fi

    # disable "more"
    - echo "more('off');" >> $OCTAVERC

    # verify that externals are all there
    - for i in $EXTERNALS; do
          $OCTAVE --eval "addpath('$MVPAPATH');
                          fprintf('External %s:\n','$i');
                          r=cosmo_check_external('$i');
                          exit(~r)" || exit 1;
      done

script:
    - cd ${COSMOPATH}
    - make test

