function test_suite=test_meeg_find_layout()
    initTestSuite;

function test_meeg_find_layout_()
    coverage=1; % allow for covering subset only

    props=get_props();
    n=numel(props);
    prev_name='';

    rp=randperm(n);
    rp=rp(1:ceil((coverage*n)));
    for k=1:numel(rp)
        prop=props{rp(k)};

        name=prop{1};
        chantype=prop{2};
        lay_prop=prop{3};
        parent_lay_prop=prop{4};
        unsupp=prop{5};

        if ~strcmp(prev_name,name)
            ds=cosmo_synthetic_dataset('type','meeg','size','big',...
                                'sens',name,'ntargets',1,'nchunks',1);
        end

        lay=cosmo_meeg_find_layout(ds,'chantype',chantype);

        check_lay(lay,lay_prop);
        if ~isempty(parent_lay_prop)
            check_lay(lay.parent,parent_lay_prop);
        end

        for j=1:numel(unsupp)
            assertExceptionThrown(@()cosmo_meeg_find_layout(ds,...
                            'chantype',unsupp{j}),'');
        end

        prev_name=name;
    end


function check_lay(lay,lay_prop)
    if isempty(lay.name) && isempty(lay_prop{1})
        return
    end
    assertEqual(lay.name,lay_prop{1});

    nchans=lay_prop{2};
    assertEqual(size(lay.pos,1),nchans);

    chans=lay_prop{3};
    has_child=~isempty(lay_prop{5});
    assertEqual(has_child, isfield(lay,'child_label'));

    for j=1:numel(chans)
        if j==1
            cpos=1;
        elseif j==numel(chans)
            cpos=nchans;
        end
        if ~strcmp(chans{j},lay.label(cpos))
            cpos=strcmp(chans{j},lay.label,'exact');
            assert(numel(cpos)==1)
        end
        assertVectorsAlmostEqual(lay.pos(cpos,:),lay_prop{4}(j,:),...
                            'absolute',1e-4);
        if has_child
            assertEqual(lay.child_label{cpos},lay_prop{5}{j});
        end
    end







function props=get_props()
    props={{'neuromag306_all','meg_planar',...
		{'neuromag306planar.lay',204,...
				{'MEG0113', 'MEG2643'},...
				[-73.4162 33.4167;61.2202 -20.3860],...
				[]},...
		[],...
		{'eeg', 'meg_planar_combined'}},...
{'neuromag306_all','meg_axial',...
		{'neuromag306mag.lay',102,...
				{'MEG0111', 'MEG2641'},...
				[-67.4162 35.9167;67.2202 -22.8860],...
				[]},...
		[],...
		{'eeg', 'meg_planar_combined'}},...
{'neuromag306_all','meg_combined_from_planar',...
		{'neuromag306planar.lay',204,...
				{'MEG0113', 'MEG2643'},...
				[-73.4162 33.4167;61.2202 -20.3860],...
				[]},...
		{'neuromag306cmb.lay',102,...
				{'MEG0112+0113', 'MEG2642+2643'},...
				[-67.4162 35.9167;67.2202 -22.8860],...
				{{'MEG0112', 'MEG0113'},{'MEG2642', 'MEG2643'}}},...
		{'eeg', 'meg_planar_combined'}},...
{'neuromag306_planar','meg_planar',...
		{'neuromag306planar.lay',204,...
				{'MEG0113', 'MEG2643'},...
				[-73.4162 33.4167;61.2202 -20.3860],...
				[]},...
		[],...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'neuromag306_planar','meg_combined_from_planar',...
		{'neuromag306planar.lay',204,...
				{'MEG0113', 'MEG2643'},...
				[-73.4162 33.4167;61.2202 -20.3860],...
				[]},...
		{'neuromag306cmb.lay',102,...
				{'MEG0112+0113', 'MEG2642+2643'},...
				[-67.4162 35.9167;67.2202 -22.8860],...
				{{'MEG0112', 'MEG0113'},{'MEG2642', 'MEG2643'}}},...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'neuromag306_planar_combined','meg_planar_combined',...
		{'neuromag306cmb.lay',102,...
				{'MEG0112+0113', 'MEG2642+2643'},...
				[-67.4162 35.9167;67.2202 -22.8860],...
				[]},...
		[],...
		{'eeg', 'meg_axial', 'meg_combined_from_planar', 'meg_planar'}},...
{'ctf151','meg_axial',...
		{'CTF151.lay',153,...
				{'MLC11', 'COMNT'},...
				[-0.4400 -4.0000;-5.5000 -1.5000],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'ctf151_planar','meg_planar',...
		{'',302,...
				{'MLC11_dH', 'MZP02_dV'},...
				[-0.4400 -4.0000;0.0000 -7.2900],...
				[]},...
		[],...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'ctf151_planar','meg_combined_from_planar',...
		{'',302,...
				{'MLC11_dH', 'MZP02_dV'},...
				[-0.4400 -4.0000;0.0000 -7.2900],...
				[]},...
		{'CTF151.lay',153,...
				{'MLC11', 'COMNT'},...
				[-0.4400 -4.0000;-5.5000 -1.5000],...
				{{'MLC11_dH', 'MLC11_dV'},[]}},...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'ctf151_planar_combined','meg_planar_combined',...
		{'CTF151.lay',153,...
				{'MLC11', 'COMNT'},...
				[-0.4400 -4.0000;-5.5000 -1.5000],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'4d148','meg_axial',...
		{'4D148.lay',148,...
				{'A1', 'A148'},...
				[0.5000 0.5644;0.9055 0.8111],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'4d148_planar','meg_planar',...
		{'',296,...
				{'A1_dH', 'A148_dV'},...
				[0.5000 0.5644;0.9055 0.8111],...
				[]},...
		[],...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'4d148_planar','meg_combined_from_planar',...
		{'',296,...
				{'A1_dH', 'A148_dV'},...
				[0.5000 0.5644;0.9055 0.8111],...
				[]},...
		{'4D148.lay',148,...
				{'A1', 'A148'},...
				[0.5000 0.5644;0.9055 0.8111],...
				{{'A1_dH', 'A1_dV'},{'A148_dH', 'A148_dV'}}},...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'4d148_planar_combined','meg_planar_combined',...
		{'4D148.lay',148,...
				{'A1', 'A148'},...
				[0.5000 0.5644;0.9055 0.8111],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'4d248','meg_axial',...
		{'4D248.lay',248,...
				{'A1', 'A248'},...
				[0.2306 -0.2606;34.3069 26.8896],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'4d248_planar','meg_planar',...
		{'',496,...
				{'A1_dH', 'A248_dV'},...
				[0.2306 -0.2606;34.3069 26.8896],...
				[]},...
		[],...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'4d248_planar','meg_combined_from_planar',...
		{'',496,...
				{'A1_dH', 'A248_dV'},...
				[0.2306 -0.2606;34.3069 26.8896],...
				[]},...
		{'4D248.lay',248,...
				{'A1', 'A248'},...
				[0.2306 -0.2606;34.3069 26.8896],...
				{{'A1_dH', 'A1_dV'},{'A248_dH', 'A248_dV'}}},...
		{'eeg', 'meg_axial', 'meg_planar_combined'}},...
{'4d248_planar_combined','meg_planar_combined',...
		{'4D248.lay',248,...
				{'A1', 'A248'},...
				[0.2306 -0.2606;34.3069 26.8896],...
				[]},...
		[],...
		{'eeg', 'meg_combined_from_planar', 'meg_planar'}},...
{'eeg1020','',...
		{'elec1020.lay',21,...
				{'Fp1', 'O2'},...
				[-0.3800 0.8911;0.3800 -0.8910],...
				[]},...
		[],...
		{'meg_axial', 'meg_combined_from_planar', 'meg_planar', 'meg_planar_combined'}},...
{'eeg1010','',...
		{'elec1010.lay',86,...
				{'Fp1', 'I2'},...
				[-0.2472 0.7609;0.3090 -0.9511],...
				[]},...
		[],...
		{'meg_axial', 'meg_combined_from_planar', 'meg_planar', 'meg_planar_combined'}},...
{'eeg1005','',...
		{'elec1005.lay',335,...
				{'Fp1', 'OI2'},...
				[-0.2472 0.7609;0.2782 -0.8559],...
				[]},...
		[],...
		{'meg_axial', 'meg_combined_from_planar', 'meg_planar', 'meg_planar_combined'}},...
    };


